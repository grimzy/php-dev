#!/usr/bin/env bash

echo "************************************************"
echo "*               Start build hook               *"
echo "************************************************"
echo

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

# shellcheck source=./_common
. "$DIR/_common"

for php_version in $PHP_VERSIONS; do
  xdebug_version=
  if [ "$php_version" == "5.5" ] || [ "$php_version" == "5.6" ]; then
    echo "Using XDebug version: ${xdebug_version:-latest}"
    xdebug_version=-2.5.5
  fi
  for php_variant in $PHP_VARIANTS; do
    if [ -z "$HAS_IMAGE_NAME" ] || [ -z "$IMAGE_NAME" ]; then
      IMAGE_NAME="$DOCKER_REPO:$php_version-$php_variant-$SOURCE_BRANCH"
      echo ">>> Set IMAGE_NAME to: $IMAGE_NAME"
    fi

    echo "Building image: $IMAGE_NAME"
    docker build \
      -t "$IMAGE_NAME" \
      --build-arg BUILD_PHP_VERSION="$php_version" \
      --build-arg BUILD_PHP_VARIANT="$php_variant" \
      --build-arg BUILD_XDEBUG_VERSION="$xdebug_version" "$DIR/.."
  done
done

echo
echo "************************************************"
echo "*                End build hook                *"
echo "************************************************"
echo

exit 0
